<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursors</title>
    <style>
        :root {
            color-scheme: dark;
            cursor: url(./cursor.svg), auto;
            overflow: hidden;
        }
    </style>
</head>
<body>

<script>
    const throttle = (cb, delay = 32) => {
        let shouldWait = false
        let waitingArgs
        const timeoutFunc = () => {
            if (waitingArgs == null) {
                shouldWait = false
            } else {
                cb(...waitingArgs)
                waitingArgs = null
                setTimeout(timeoutFunc, delay)
            }
        }

        return (...args) => {
            if (shouldWait) {
                waitingArgs = args
                return
            }

            cb(...args)
            shouldWait = true
            setTimeout(timeoutFunc, delay)
        }
    }

    const createCursor = () => {
        const cursor = document.createElement('img')
        cursor.src = './cursor.svg'
        cursor.style.transition = 'all 0.04s ease-in-out'
        return cursor
    }

    const events = {
        getInitialData: 0,
        connect: 1,
        move: 2,
        exit: 3,
    }

    let ws, myId, cursors = {}

    const wsSend = (data) => {
            switch(ws.readyState) {
                case 0:
                    setTimeout(() => wsSend(data), 100)
                    break
                case 1:
                    ws.send(data)
                    break
                case 3:
                    initConnection()
                    break
            }
        }

    const sendCursorPosition = throttle((x, y) => wsSend(JSON.stringify([events.move, x, y])))

    const initConnection = throttle(() => {
        ws = new WebSocket("ws://localhost:9000")

        ws.onopen = () => {
            console.log('connected')
        }

        ws.onmessage = (m) => {
            /*
                m.data is a JSON array
                [
                    number // cursor id
                    [
                        number // event type
                        number // x
                        number // y
                    ]
                ]
            */
            const data = JSON.parse(m.data)
            switch (data[0]) {
                case events.getInitialData:
                    myId = data[1]
                    for (const cursorId in data[2]) {
                        const cursorEl = createCursor()
                        cursorEl.style.transform = `translate(${data[2][cursorId][0]}px, ${data[2][cursorId][1]}px)`
                        cursors[cursorId] = cursorEl
                        document.body.appendChild(cursorEl)
                    }
                    break
                case events.connect:
                    if (data[1] === myId) break
                    const cursorEl = createCursor()
                    cursors[data[1]] = cursorEl
                    document.body.appendChild(cursorEl)
                    break
                case events.move:
                    if (data[1] === myId) break
                    cursors[data[1]].style.transform = `translate(${data[2]}px, ${data[3]}px)`
                    break
                case events.exit:
                    document.body.removeChild(cursors[data[1]])
                    delete cursors[data[1]]
                    break
            }
        }

        ws.onclose = (event) => {
            if (event.wasClean) {
                console.log('Connection closed')
            } else {
                console.log('Connection lost')
            }
            console.log('Code: ' + event.code + ' reason: ' + event.reason)
        }

        ws.onerror = (error) => {
            console.log(error)
        }
    }, 600)

    initConnection()

    addEventListener('mousemove', (e) => {
        try {
            sendCursorPosition(e.clientX, e.clientY)
        } catch (e) {
            console.log(e)
            // initConnection()
        }
    })

</script>

</body>
</html>
